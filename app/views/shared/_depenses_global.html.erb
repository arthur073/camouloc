<section class="content-header">
  <h1>
    Expenses
  </h1>
</section>
<!-- Main content -->
<section class="content">

  <div class="row">
    <div class="col-md-6">
            <div class="box box-primary">
                    <div class="box-header with-border">
                      <h3 class="box-title">Tweet your expense to save time</h3>
                      <div class="box-tools pull-right">
                      </div>
                    </div><!-- /.box-header -->
                    <div class="box-body">
						<br>
						Try this example: <i> "I just got back from #shopping for @<%= @roommates[0].nom.gsub(" ","_") %> and @<%= @roommates[1].nom.gsub(" ","_") %>. Spent 100€." </i>
						<br><br>
						<%= form_tag "/saveexpense", "data-toggle" => "validator", :id => "tweetForm", :onsubmit => "tweetSubmit(); return false" do -%>
						  <div class="form-group has-feedback">
							<%= text_field_tag "tweet", nil, class: "form-control", placeholder: "Tweet your expense", "data-roommates" => "bar", "data-reason" => "bar", "data-amount" => "bar"%>
							<span class="help-block"><i>Expense author is <strong id="expense_author_view"><%= current_user.nom %></strong>, you can change it below</i></span>
							<span class="glyphicon glyphicon-star form-control-feedback"></span>
							<div class="help-block with-errors">
								<div id="errorRoom" style="display:none"></div>
								<div id="errorReas" style="display:none"></div>
								<div id="errorAmou" style="display:none"></div>
							</div>
						  </div>
		                  <%= submit_tag "Tweet an expense", :class => "btn btn-primary btn-block btn-flat" %>
					  <% end %>
                    </div><!-- /.box-body -->
                    <div class="box-footer clearfix">
                    </div><!-- /.box-footer -->
		  </div>
		  
            <div class="box box-primary">
                    <div class="box-header with-border">
                      <h3 class="box-title">Or do it the old fashion way</h3>
                      <div class="box-tools pull-right">
                      </div>
                    </div><!-- /.box-header -->
                    <div class="box-body">
						<%= form_tag "/saveexpense", "data-toggle" => "validator", :id => "expenseForm" do -%>
						  <div class="form-group has-feedback">
							<label>Author</label>
							<%= select_tag :user_id, options_for_select(@roommates.map{ |c| [c.nom, c.id]}, [current_user.nom, current_user.id]), {:id => "expense_author", :class => "form-control" } %>
							<div class="help-block with-errors"></div>
						  </div>
						  <div class="form-group has-feedback">
							<label>Roommates involved</label>
							<%= select_tag "roommates_involved", options_for_select(@roommates.map{ |c| [c.nom.gsub(" ","_"), c.id]}), {:id => "roommates", :class => "form-control", :multiple => true, :required => true } %>
							<span class="glyphicon glyphicon-user form-control-feedback"></span>														
							<div class="help-block with-errors"></div>
						  </div>				  						  
						  <div class="form-group has-feedback">
							<label>Reason</label>
							<%= text_field_tag "raison", nil, :id => "reason", :class => "form-control", :placeholder => "Why have you spent this money?", :required => true %>
							<span class="glyphicon glyphicon-pencil form-control-feedback"></span>
							<div class="help-block with-errors"></div>
						  </div>	
						  <div class="form-group has-feedback">
							<label>Value</label>
							<%= text_field_tag "montant", nil, :id => "amount", :class => "form-control", 
								:placeholder => "How much money have you spent?", :required => true, 
								"pattern" => '^\d+[,.]?(\d*)?€', "data-error" => "Input can only be digits followed by \"€\" (ex: 1€ 1.23€ or 1,23€)" %>
							<span class="glyphicon glyphicon-euro form-control-feedback"></span>
							<div class="help-block with-errors"></div>
						  </div>	
		                  <%= submit_tag "Add an expense", :class => "btn btn-primary btn-block btn-flat"%>
		                  <%= hidden_field_tag :coloc_id, @coloc.id %>	  
		                  <%= hidden_field_tag :coloc_secret, @coloc.secret %>	  
						<% end %>					
                    </div><!-- /.box-body -->
                    <div class="box-footer clearfix">
                    </div><!-- /.box-footer -->
		  </div>
	</div>   
   <div class="col-md-6">
            <div class="box box-primary">
                    <div class="box-header with-border">
                      <h3 class="box-title">Latest expenses</h3>
                      <div class="box-tools pull-right">
                        <span class="label label-primary"><%= @expenses.count %> expenses in total</span>
                      </div>
                    </div><!-- /.box-header -->
                    <div class="box-body">
                      <div class="table-responsive">
                        <table class="table no-margin" id="expenseTable">
                          <thead>
                            <tr>
                              <th>Author</th>
                              <th>Reason</th>
                              <th>Roommates involved</th>
                              <th>Value</th>
                            </tr>
                          </thead>
                          <tbody>
                            <% @expenses.reverse_each do |e| %>
                            <tr>
                              <td><%= link_to User.find(e.user_id).nom, User.find(e.user_id) %></td>
                              <td><%= e.raison %></td>                              
                              <td width="50%"><%= e.roommates_involved %></td>
                              <td><%= number_to_currency(e.montant) %>
								<button type="button" class="btn btn-xs btn-danger pull-right" data-toggle="modal" data-target="#myModal" 
									onclick="populateRemoveModal(<%= e.id %>, '<%= User.find(e.user_id).nom %>','<%= number_to_currency(e.montant, precision: 2) %>','<%= e.raison %>', '<%= e.roommates_involved %>', '<%= url_for e %>');">
									<span class='glyphicon glyphicon-trash'></span>
								</button>								  
							  </td>
                            </tr>
                            <% end %>
                          </tbody>
                        </table>
                      </div><!-- /.table-responsive -->
                    </div><!-- /.box-body -->
                    <div class="box-footer clearfix">
                    </div><!-- /.box-footer -->
		  </div>
	</div>
   </div>
   <div class="row">
    <div class="col-md-6">

	</div>
</div>	
</section>


<%= javascript_include_tag "jquery.caret.min", "jquery.atwho.min", "select2.min" %>
<script type="text/javascript">

	var $multi = $("#roommates").select2({
		  placeholder: "Select your roommates"	
    });
	
	var multiOptions = []
	$("#roommates > option").each(function() {
		multiOptions.push({
			text: this.text,
			val: this.value,
			enabled: false
		});
	});
	
	$('#tweetForm').validator({
		custom: {
			roommates: function($el) { 
				var value = $("#tweet").val();
				return extractFromRegexp(value, /(^|\W)(@[a-z\d][\w-]*)/ig, "roommates", true);
			}, 
			reason: function($el) { 
				var value = $("#tweet").val();
				return extractFromRegexp(value, /(^|\W)(#[a-z\d][\w-]*)/i, "reason");
			} , 
			amount: function($el) { 
				var value = $("#tweet").val();
				return extractFromRegexp(value, /(^|\W)([a-z\d][\w-,.]*[ ]?€)/i, "amount");
			}
		},
		errors: {
			roommates: 'Mention your roommates using "@"',
			reason: 'Specify a reason with "#"',
			amount: 'Specify the expense amount with "€"'
		}
	});
	$('#expenseForm').validator({});

	$('#tweet').atwho({
		at: "@",
		data:<%= raw @roommates.map{|c| c.nom.gsub(" ","_") }.to_json %>
	}).atwho({
	   at: "#",
		data:<%= raw @expenses.last(5).map{|e| e.raison }.to_json %>
	});
	
	$multi.on("select2:select", function(e) {
		var inputVal = $("#tweet").val();
		if (inputVal.indexOf(e.params.data.text) == -1) {
			$("#tweet").val(inputVal += " @" + e.params.data.text);
		}			
	});

	$multi.on("select2:unselect", function(e) {
		var inputVal = $("#tweet").val();
		if (inputVal.indexOf(e.params.data.text) > -1) {
			$("#tweet").val(inputVal.replace("@" + e.params.data.text, ""));
		}	
	});

	var extractFromRegexp = function(value, regexp, target, global) {
		global = global || false;
		var splitHash = value.match(regexp);
		if (splitHash != null) {
			if (global) {
				splitHash = splitHash.map(function(e) {
					return e.trim().substring(1);
				});
				multiOptions.forEach(function(elem) {
					if (splitHash.indexOf(elem.text) > -1) {
						if (!elem.enabled) { elem.enabled = true; }
					} else {	
						if (elem.enabled) { elem.enabled = false; }
					}
				});
				var selectedRoommates = multiOptions.map(function(elem) {
					if (elem.enabled) { return elem.val; } else { return ""; }
				});
				$multi.val(selectedRoommates.filter(function(elem) { return elem != ""})).trigger("change");
			} else {
				if (target == "amount") {
					$("#amount").val(splitHash[2]);
				} else if (target == "reason") {
					$("#reason").val(splitHash[2].substring(1));
				}
			}
			return true;
		} else {
			return false;   
		}
	}
	
	$("#expense_author").change(function() {
		$("#expense_author_view").text($("#expense_author option:selected").text());
	});
	
	$("#reason").on('keyup', function(e) {
		var tweetValue = $("#tweet").val();
		var regexp = new RegExp('[ ]?#([^\\s]*)','g');
		var tweetValue = tweetValue.replace(regexp, "");
		if ($(this).val() == "") {
			$("#tweet").val(tweetValue);
		} else {
			$("#tweet").val(tweetValue + " #" + $(this).val().replace(/ /g,"_"));
		}
	});
	
	$("#amount").on('keyup', function(e) {
		var tweetValue = $("#tweet").val();
		var tweetValue = tweetValue.replace(/(^|\W)([ ]?[\d][\w-,.]*[ ]?€)/i, "");
		if ($(this).val().substr($(this).val().length - 1) == "€") {
			$("#tweet").val(tweetValue + " " + $(this).val());
		} else if ($(this).val() == "") {
			$("#tweet").val(tweetValue);
		}
	});

	var tweetSubmit = function() {
		$("#expenseForm").submit();
	};
	
	$("#expenseTable").DataTable({
          "paging": true,
          "lengthChange": false,
          "searching": false,
          "ordering": true,
          "info": true,
          "autoWidth": false,
		  "pageLength": 15
	});
</script>
